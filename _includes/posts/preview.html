{% assign posts = site.posts %}

{% comment %}
================================================================================
Filter Posts (by category, tag, author, year and limit)
================================================================================
{% endcomment %}

{% if include.category %}
  {% assign posts = posts | where: "categories", include.category %}
{% endif %}

{% if include.tag %}
  {% assign posts = posts | where: "tags", include.tag %}
{% endif %}

{% if include.author %}
  {% assign posts = posts | where: "tags", include.tag %}
{% endif %}

{% if include.year %}
  {% assign groups = posts | group_by_exp: "post", "post.date | date: '%Y'" %}
  {% assign groups = groups | where: "name", include.year %}
  {% assign posts = groups[0].items %}
{% endif %}

{% if include.limit %}
  {% assign bound = include.limit %}
{% else %}
  {% assign bound = 9999 %}
{% endif %}

<div class="grid" style="padding: 1rem 0;">

{% for post in posts limit: bound %}

{% assign readtime = post.content | number_of_words | divided_by: 180 | plus: 0.5 | round %}
{% assign offset = post.title | number_of_words | times: 2 %}
{% assign cutoff = 35 | minus: offset %}

{% if post.cloudinary %}
  {% assign preview = "https://res.cloudinary.com/frootlab/image/upload/c_thumb,w_300,g_face/" | append: post.cloudinary | append: ".webp" %}
{% elsif post.preview %}
  {% assign preview = site.url | append: post.preview %}
{% elsif post.image %}
  {% assign preview = site.url | append: post.image %}
{% else %}
  {% assign preview = site.url | append: post.image %}
{% endif %}

{% assign catid = post.categories | first | downcase %}
{% case catid %}
  {% when 'corporate' %}
    {% assign color = 'blue' %}
  {% when 'science'' %}
    {% assign color = 'green' %}
  {% when 'technology' %}
    {% assign color = 'red' %}
  {% else %}
    {% assign color = 'grey' %}
{% endcase %}

<div class="cell">
  <a href="{{ site.url }}{{ post.url }}" title="{{ post.title }}">
  <div class="card">
    <div class="ribbon-box">
      <div class="ribbon-wrapper">
          <div class="{{ color }}-ribbon">{{ catid }}</div>
      </div>
    </div>
    <div class="card-image" style="background-image: url({{ preview }});"></div>
    <div class="card-content">
      <div class="label">{{ post.date | date: '%d %b %Y' }} &nbsp;&bull;&nbsp; {{ readtime }} min</div>
      <div class="card-title">{{ post.title | markdownify | strip_html }}</div>
      <div class="card-text">{{ post.excerpt | strip_html | truncatewords: cutoff}}</div>
    </div>
  </div>
  </a>
</div>

{% endfor %}

<div class="cell"></div>
<div class="cell"></div>

</div>
